"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("three"),r=require("@react-three/fiber"),n=require("../../core/Line.cjs.js"),o=require("../Html.cjs.js"),a=require("lodash.clamp"),i=require("./context.cjs.js");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("@babel/runtime/helpers/extends"),require("three-stdlib"),require("react-dom/client");var l=s(e),u=s(t),d=c(a);const p=new u.Vector3,m=new u.Vector3,f=e=>180*e/Math.PI,h=e=>{let t=((e,t)=>{let r=Math.floor(e/t);return r=r<0?r+1:r,e-r*t})(e,2*Math.PI);return Math.abs(t)<1e-6?0:(t<0&&(t+=2*Math.PI),t)},x=new u.Matrix4,P=new u.Vector3,M=new u.Ray,b=new u.Vector3;exports.AxisRotator=({dir1:e,dir2:t,axis:a})=>{const{rotationLimits:c,annotations:s,annotationsClass:y,depthTest:g,scale:w,lineWidth:v,fixed:C,axisColors:j,hoveredColor:I,opacity:k,onDragStart:q,onDrag:O,onDragEnd:R,userData:V}=l.useContext(i.context),F=r.useThree((e=>e.controls)),D=l.useRef(null),E=l.useRef(null),W=l.useRef(0),z=l.useRef(0),T=l.useRef(null),[A,L]=l.useState(!1),_=l.useCallback((e=>{s&&(D.current.innerText=`${f(z.current).toFixed(0)}ยบ`,D.current.style.display="block"),e.stopPropagation();const t=e.point.clone(),r=(new u.Vector3).setFromMatrixPosition(E.current.matrixWorld),n=(new u.Vector3).setFromMatrixColumn(E.current.matrixWorld,0).normalize(),o=(new u.Vector3).setFromMatrixColumn(E.current.matrixWorld,1).normalize(),i=(new u.Vector3).setFromMatrixColumn(E.current.matrixWorld,2).normalize(),c=(new u.Plane).setFromNormalAndCoplanarPoint(i,r);T.current={clickPoint:t,origin:r,e1:n,e2:o,normal:i,plane:c},q({component:"Rotator",axis:a,origin:r,directions:[n,o,i]}),F&&(F.enabled=!1),e.target.setPointerCapture(e.pointerId)}),[s,F,q,a]),S=l.useCallback((e=>{if(e.stopPropagation(),A||L(!0),T.current){const{clickPoint:t,origin:r,e1:n,e2:o,normal:i,plane:l}=T.current,[u,y]=(null==c?void 0:c[a])||[void 0,void 0];M.copy(e.ray),M.intersectPlane(l,b),M.direction.negate(),M.intersectPlane(l,b);let g=((e,t,r,n,o)=>{p.copy(e).sub(r),m.copy(t).sub(r);const a=n.dot(n),i=o.dot(o),c=p.dot(n)/a,s=p.dot(o)/i,l=m.dot(n)/a,u=m.dot(o)/i,d=Math.atan2(s,c);return Math.atan2(u,l)-d})(t,b,r,n,o),w=f(g);e.shiftKey&&(w=10*Math.round(w/10),g=(e=>e*Math.PI/180)(w)),void 0!==u&&void 0!==y&&y-u<2*Math.PI?(g=h(g),g=g>Math.PI?g-2*Math.PI:g,g=d.default(g,u-W.current,y-W.current),z.current=W.current+g):(z.current=h(W.current+g),z.current=z.current>Math.PI?z.current-2*Math.PI:z.current),s&&(w=f(z.current),D.current.innerText=`${w.toFixed(0)}ยบ`),x.makeRotationAxis(i,g),P.copy(r).applyMatrix4(x).sub(r).negate(),x.setPosition(P),O(x)}}),[s,O,A,c,a]),H=l.useCallback((e=>{s&&(D.current.style.display="none"),e.stopPropagation(),W.current=z.current,T.current=null,R(),F&&(F.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[s,F,R]),N=l.useCallback((e=>{e.stopPropagation(),L(!1)}),[]),U=l.useMemo((()=>{const r=e.clone().normalize(),n=t.clone().normalize();return(new u.Matrix4).makeBasis(r,n,r.clone().cross(n))}),[e,t]),$=C?.65:.65*w,B=l.useMemo((()=>{const e=[];for(let t=0;t<=32;t++){const r=t*(Math.PI/2)/32;e.push(new u.Vector3(Math.cos(r)*$,Math.sin(r)*$,0))}return e}),[$]);return l.createElement("group",{ref:E,onPointerDown:_,onPointerMove:S,onPointerUp:H,onPointerOut:N,matrix:U,matrixAutoUpdate:!1},s&&l.createElement(o.Html,{position:[$,$,0]},l.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:y,ref:D})),l.createElement(n.Line,{points:B,lineWidth:4*v,visible:!1,userData:V}),l.createElement(n.Line,{transparent:!0,raycast:()=>null,depthTest:g,points:B,lineWidth:v,color:A?I:j[a],opacity:k,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))};
