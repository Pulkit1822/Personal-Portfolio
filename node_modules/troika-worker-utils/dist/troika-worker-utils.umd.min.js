'use strict';(function(h,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define(["exports"],n):(h="undefined"!==typeof globalThis?globalThis:h||self,n(h.troika_worker_utils={}))})(this,function(h){function n(){function b(a,c){var d=a.id,g=a.name,l=a.dependencies;void 0===l&&(l=[]);var k=a.init;void 0===k&&(k=function(){});a=a.getTransferables;void 0===a&&(a=null);if(!f[d])try{l=l.map(function(a){a&&a.isWorkerModule&&(b(a,function(a){if(a instanceof
Error)throw a;}),a=f[a.id].value);return a}),k=e("<"+g+">.init",k),a&&(a=e("<"+g+">.getTransferables",a)),g=null,"function"===typeof k?g=k.apply(void 0,l):console.error("worker module init function failed to rehydrate"),f[d]={id:d,value:g,getTransferables:a},c(g)}catch(m){m&&m.noLog||console.error(m),c(m)}}function d(a,b){function c(a){try{var c=f[e].getTransferables&&f[e].getTransferables(a);c&&Array.isArray(c)&&c.length||(c=void 0);b(a,c)}catch(v){console.error(v),b(v)}}var d,e=a.id;a=a.args;f[e]&&
"function"===typeof f[e].value||b(Error("Worker module "+e+": not found or its 'init' did not return a function"));try{var k=(d=f[e]).value.apply(d,a);k&&"function"===typeof k.then?k.then(c,function(a){return b(a instanceof Error?a:Error(""+a))}):c(k)}catch(m){b(m)}}function e(a,b){var c=void 0;self.troikaDefine=function(a){return c=a};a=URL.createObjectURL(new Blob(["/** "+a.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+b+"\n)"],{type:"application/javascript"}));try{importScripts(a)}catch(g){console.error(g)}URL.revokeObjectURL(a);
delete self.troikaDefine;return c}var f=Object.create(null);self.addEventListener("message",function(a){var c=a.data,e=c.messageId;a=c.action;c=c.data;try{"registerModule"===a&&b(c,function(a){a instanceof Error?postMessage({messageId:e,success:!1,error:a.message}):postMessage({messageId:e,success:!0,result:{isCallable:"function"===typeof a}})}),"callModule"===a&&d(c,function(a,b){a instanceof Error?postMessage({messageId:e,success:!1,error:a.message}):postMessage({messageId:e,success:!0,result:a},
b||void 0)})}catch(g){postMessage({messageId:e,success:!1,error:g.stack})}})}function z(b){var d=function(){for(var b=[],f=arguments.length;f--;)b[f]=arguments[f];return d._getInitResult().then(function(a){if("function"===typeof a)return a.apply(void 0,b);throw Error("Worker module function was called but `init` did not return a callable function");})};d._getInitResult=function(){var e=b.dependencies,f=b.init;e=Array.isArray(e)?e.map(function(a){return a&&a._getInitResult?a._getInitResult():a}):[];
var a=Promise.all(e).then(function(a){return f.apply(null,a)});d._getInitResult=function(){return a};return a};return d}function w(b){function d(){for(var a=[],b=arguments.length;b--;)a[b]=arguments[b];if(!l){l=x(c,"registerModule",d.workerModuleData);var e=function(){l=null;p[c].delete(e)};(p[c]||(p[c]=new Set)).add(e)}return l.then(function(b){if(b.isCallable)return x(c,"callModule",{id:h,args:a});throw Error("Worker module function was called but `init` did not return a callable function");})}
if(!(b&&"function"===typeof b.init||t))throw Error("requires `options.init` function");var e=b.dependencies,f=b.init,a=b.getTransferables,c=b.workerId;if(!y())return z(b);null==c&&(c="#default");var h="workerModule"+ ++A,g=b.name||h,l=null;e=e&&e.map(function(a){"function"!==typeof a||a.workerModuleData||(t=!0,a=w({workerId:c,name:"<"+g+"> function dependency: "+a.name,init:"function(){return (\n"+q(a)+"\n)}"}),t=!1);a&&a.workerModuleData&&(a=a.workerModuleData);return a});d.workerModuleData={isWorkerModule:!0,
id:h,name:g,dependencies:e,init:q(f),getTransferables:a&&q(a)};return d}function q(b){b=b.toString();!/^function/.test(b)&&/^\w+\s*\(/.test(b)&&(b="function "+b);return b}function B(b){var d=r[b];d||(d=q(n),d=r[b]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+b.replace(/\*/g,"")+" **/\n\n;("+d+")()"],{type:"application/javascript"}))),d.onmessage=function(b){b=b.data;var d=b.messageId,a=u[d];if(!a)throw Error("WorkerModule response with empty or unknown messageId");delete u[d];
a(b)});return d}function x(b,d,e){return new Promise(function(f,a){var c=++C;u[c]=function(b){b.success?f(b.result):a(Error("Error in worker "+d+" call: "+b.error))};B(b).postMessage({messageId:c,action:d,data:e})})}var y=function(){var b=!1;if("undefined"!==typeof window&&"undefined"!==typeof window.document)try{(new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})))).terminate(),b=!0}catch(d){"undefined"!==typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+
d.message+"]")}y=function(){return b};return b},A=0,C=0,t=!1,r=Object.create(null),p=Object.create(null),u=Object.create(null);h.defineWorkerModule=w;h.stringifyFunction=q;h.terminateWorker=function(b){p[b]&&p[b].forEach(function(b){b()});r[b]&&(r[b].terminate(),delete r[b])};Object.defineProperty(h,"__esModule",{value:!0})})
