"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three");class t extends e.Mesh{constructor(t){const i=new o(t),s=new e.PlaneGeometry(.001*i.image.width,.001*i.image.height),r=new e.MeshBasicMaterial({map:i,toneMapped:!1,transparent:!0});function l(e){r.map.dispatchDOMEvent(e)}super(s,r),this.addEventListener("mousedown",l),this.addEventListener("mousemove",l),this.addEventListener("mouseup",l),this.addEventListener("click",l),this.dispose=function(){s.dispose(),r.dispose(),r.map.dispose(),n.delete(t),this.removeEventListener("mousedown",l),this.removeEventListener("mousemove",l),this.removeEventListener("mouseup",l),this.removeEventListener("click",l)}}}class o extends e.CanvasTexture{constructor(t){super(i(t)),this.dom=t,this.anisotropy=16,this.encoding=e.sRGBEncoding,this.minFilter=e.LinearFilter,this.magFilter=e.LinearFilter;const o=new MutationObserver((()=>{this.scheduleUpdate||(this.scheduleUpdate=setTimeout((()=>this.update()),16))}));o.observe(t,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.observer=o}dispatchDOMEvent(e){e.data&&function(e,t,o,n){const i={clientX:o*e.offsetWidth+e.offsetLeft,clientY:n*e.offsetHeight+e.offsetTop,view:e.ownerDocument.defaultView};window.dispatchEvent(new MouseEvent(t,i));const s=e.getBoundingClientRect();function r(e){if(e.nodeType!==Node.TEXT_NODE&&e.nodeType!==Node.COMMENT_NODE){const s=e.getBoundingClientRect();if(o>s.left&&o<s.right&&n>s.top&&n<s.bottom&&(e.dispatchEvent(new MouseEvent(t,i)),e instanceof HTMLInputElement&&"range"===e.type&&("mousedown"===t||"click"===t))){const[t,n]=["min","max"].map((t=>parseFloat(e[t]))),i=s.width,r=(o-s.x)/i;e.value=t+(n-t)*r,e.dispatchEvent(new InputEvent("input",{bubbles:!0}))}for(let t=0;t<e.childNodes.length;t++)r(e.childNodes[t])}}o=o*s.width+s.left,n=n*s.height+s.top,r(e)}(this.dom,e.type,e.data.x,e.data.y)}update(){this.image=i(this.dom),this.needsUpdate=!0,this.scheduleUpdate=null}dispose(){this.observer&&this.observer.disconnect(),this.scheduleUpdate=clearTimeout(this.scheduleUpdate),super.dispose()}}const n=new WeakMap;function i(t){const o=document.createRange(),i=new e.Color;function s(e,t,o,n){""!==n&&("uppercase"===e.textTransform&&(n=n.toUpperCase()),c.font=e.fontWeight+" "+e.fontSize+" "+e.fontFamily,c.textBaseline="top",c.fillStyle=e.color,c.fillText(n,t,o+.1*parseFloat(e.fontSize)))}function r(e,t,o,n,i){o<2*i&&(i=o/2),n<2*i&&(i=n/2),c.beginPath(),c.moveTo(e+i,t),c.arcTo(e+o,t,e+o,t+n,i),c.arcTo(e+o,t+n,e,t+n,i),c.arcTo(e,t+n,e,t,i),c.arcTo(e,t,e+o,t,i),c.closePath()}function l(e,t,o,n,i,s){const r=e[t+"Width"],l=e[t+"Style"],d=e[t+"Color"];"0px"!==r&&"none"!==l&&"transparent"!==d&&"rgba(0, 0, 0, 0)"!==d&&(c.strokeStyle=d,c.lineWidth=parseFloat(r),c.beginPath(),c.moveTo(o,n),c.lineTo(o+i,n+s),c.stroke())}const d=t.getBoundingClientRect();let a=n.get(t);void 0===a&&(a=document.createElement("canvas"),a.width=d.width,a.height=d.height,n.set(t,a));const c=a.getContext("2d"),h=new function(e){const t=[];let o=!1;function n(){if(o&&(o=!1,e.restore()),0===t.length)return;let n=-1/0,i=-1/0,s=1/0,r=1/0;for(let e=0;e<t.length;e++){const o=t[e];n=Math.max(n,o.x),i=Math.max(i,o.y),s=Math.min(s,o.x+o.width),r=Math.min(r,o.y+o.height)}e.save(),e.beginPath(),e.rect(n,i,s-n,r-i),e.clip(),o=!0}return{add:function(e){t.push(e),n()},remove:function(){t.pop(),n()}}}(c);return function e(t,n){let a=0,p=0,f=0,u=0;if(t.nodeType===Node.TEXT_NODE){o.selectNode(t);const e=o.getBoundingClientRect();a=e.left-d.left-.5,p=e.top-d.top-.5,f=e.width,u=e.height,s(n,a,p,t.nodeValue.trim())}else{if(t.nodeType===Node.COMMENT_NODE)return;if(t instanceof HTMLCanvasElement){if("none"===t.style.display)return;c.save();const e=window.devicePixelRatio;c.scale(1/e,1/e),c.drawImage(t,0,0),c.restore()}else{if("none"===t.style.display)return;const e=t.getBoundingClientRect();a=e.left-d.left-.5,p=e.top-d.top-.5,f=e.width,u=e.height,n=window.getComputedStyle(t),r(a,p,f,u,parseFloat(n.borderRadius));const o=n.backgroundColor;"transparent"!==o&&"rgba(0, 0, 0, 0)"!==o&&(c.fillStyle=o,c.fill());const m=["borderTop","borderLeft","borderBottom","borderRight"];let g=!0,v=null;for(const e of m){if(null!==v&&(g=n[e+"Width"]===n[v+"Width"]&&n[e+"Color"]===n[v+"Color"]&&n[e+"Style"]===n[v+"Style"]),!1===g)break;v=e}if(!0===g){const e=parseFloat(n.borderTopWidth);"0px"!==n.borderTopWidth&&"none"!==n.borderTopStyle&&"transparent"!==n.borderTopColor&&"rgba(0, 0, 0, 0)"!==n.borderTopColor&&(c.strokeStyle=n.borderTopColor,c.lineWidth=e,c.stroke())}else l(n,"borderTop",a,p,f,0),l(n,"borderLeft",a,p,0,u),l(n,"borderBottom",a,p+u,f,0),l(n,"borderRight",a+f,p,0,u);if(t instanceof HTMLInputElement){let e=n.accentColor;void 0!==e&&"auto"!==e||(e=n.color),i.set(e);const o=Math.sqrt(.299*i.r**2+.587*i.g**2+.114*i.b**2)<.5?"white":"#111111";if("radio"===t.type&&(r(a,p,f,u,u),c.fillStyle="white",c.strokeStyle=e,c.lineWidth=1,c.fill(),c.stroke(),t.checked&&(r(a+2,p+2,f-4,u-4,u),c.fillStyle=e,c.strokeStyle=o,c.lineWidth=2,c.fill(),c.stroke())),"checkbox"===t.type&&(r(a,p,f,u,2),c.fillStyle=t.checked?e:"white",c.strokeStyle=t.checked?o:e,c.lineWidth=1,c.stroke(),c.fill(),t.checked)){const e=c.textAlign;c.textAlign="center";s({color:o,fontFamily:n.fontFamily,fontSize:u+"px",fontWeight:"bold"},a+f/2,p,"âœ”"),c.textAlign=e}if("range"===t.type){const[n,i,s]=["min","max","value"].map((e=>parseFloat(t[e]))),l=(s-n)/(i-n)*(f-u);r(a,p+u/4,f,u/2,u/4),c.fillStyle=o,c.strokeStyle=e,c.lineWidth=1,c.fill(),c.stroke(),r(a,p+u/4,l+u/2,u/2,u/4),c.fillStyle=e,c.fill(),r(a+l,p,u,u,u/2),c.fillStyle=e,c.fill()}"color"!==t.type&&"text"!==t.type&&"number"!==t.type||(h.add({x:a,y:p,width:f,height:u}),s(n,a+parseInt(n.paddingLeft),p+parseInt(n.paddingTop),t.value),h.remove())}}}const m="auto"===n.overflow||"hidden"===n.overflow;m&&h.add({x:a,y:p,width:f,height:u});for(let o=0;o<t.childNodes.length;o++)e(t.childNodes[o],n);m&&h.remove()}(t),a}exports.HTMLMesh=t;
